{% extends "layout.html" %}
{% set title = '0.5m &raquo; Dashboard' -%}
{% set active_page = 'halfmetre-dashboard' -%}
{% block body %}
    <div class="row dashboard-stats">
        <div class="col-lg-3 col-md-6 col-xs-12 g-2">
            <div class="list-group rounded-0">
                <span class="list-group-item" data-index='["halfmetre_ops", "environment"]' data-generator="opsConditions" data-bs-toggle="tooltip" data-bs-placement="right">Environment</span>
                <span class="list-group-item" data-index='["halfmetre_domealert", "tel_room_temp"]' data-generator="envLatestMinMax" data-units=" &deg;C">Tel. Rm. Temp.</span>
                <span class="list-group-item" data-index='["halfmetre_domealert", "tel_room_humidity"]' data-generator="envLatestMinMax" data-units=" %RH">Tel. Rm. Humidity</span>
                <span class="list-group-item" data-index='["halfmetre_aircon", "instrument_room"]' data-generator="powerInstrAircon">Tel. Rm. Aircon</span>
                <span class="list-group-item" data-index='["halfmetre_domealert", "comp_room_temp"]' data-generator="envLatestMinMax" data-units=" &deg;C">Comp Room Temp.</span>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 col-xs-12 g-2">
            <div class="list-group rounded-0">
                <span class="list-group-item" data-index='["halfmetre_power"]' data-generator="powerUPS" data-prefix="ups1">UPS 1</span>
                <span class="list-group-item" data-index='["halfmetre_power"]' data-generator="powerUPS" data-prefix="ups2">UPS 2</span>
                <span class="list-group-item" data-index='["halfmetre_power", "ats_source"]' data-generator="powerATS">ATS</span>
                <span class="list-group-item" data-index='["halfmetre_power", "clight"]' data-generator="powerOffOn">Comp. Rm. Light</span>
                <span class="list-group-item" data-index='["halfmetre_power", "ilight"]' data-generator="powerOffOn">Tel. Rm. Light</span>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 col-xs-12 g-2">
            <div class="list-group rounded-0">
                <span class="list-group-item" data-mount-index='["halfmetre_telescope"]' data-power-index='["halfmetre_power", "mount"]' data-generator="mountState">Mount</span>
                <span class="list-group-item" data-index='["halfmetre_telescope"]' data-generator="mountRADec">RA / Dec</span>
                <span class="list-group-item" data-index='["halfmetre_telescope"]' data-generator="mountAltAz">Alt / Az</span>
                <span class="list-group-item" data-index='["halfmetre_telescope"]' data-generator="mountSunMoon">Sun / Moon Sep.</span>
                <!-- span class="list-group-item" data-focuser-index='["halfmetre_focus"]' data-power-index='["halfmetre_power", "focuser"]' data-generator="halfmetreMirrorTemperature">Mirrors Temp.</span -->
                <span class="list-group-item">Mirrors Temp.<span class="float-end">N/A</span></span>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 col-xs-12 g-2">
            <div class="list-group rounded-0">
                <span class="list-group-item" data-index='["ephem", "sun_alt"]' data-generator="envLatestMinMax" data-units="&deg;">Sun Altitude</span>
                <span class="list-group-item" data-index='["halfmetre_roof", "status"]' data-generator="roofState">Roof</span>
                <span class="list-group-item" data-index='["halfmetre_roof"]' data-generator="roofHeartbeat">Heartbeat</span>
                <span class="list-group-item" data-index='["halfmetre_power", "roofcharger"]' data-generator="powerOnOff">Roof Charger</span>
                <span class="list-group-item" data-index='["halfmetre_roof", "battery_voltage_mean"]' data-generator="roofBattery" data-units=" V">Roof Battery</span>
            </div>
        </div>
    </div>
    <div class="row dashboard-stats">
        <div class="col-lg-8 col-md-12">
            <div class="row">
                <div class="col-12 g-2">
                    <div class="list-group rounded-0">
                        <span class="list-group-item text-center fw-bold">Action Queue</span>
                        <div class="list-group-item overflow-y-scroll" style="height: 156px" data-index='["halfmetre_ops", "telescope"]' data-notify="opsActionsQueue">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 col-xs-12 g-2">
                    <div class="list-group rounded-0">
                        <span class="list-group-item" data-index='["halfmetre_ops", "dome"]' data-type="open" data-generator="opsDomeTime">Dome Open</span>
                    </div>
                </div>
                <div class="col-md-6 col-xs-12 g-2">
                    <div class="list-group rounded-0">
                        <span class="list-group-item" data-index='["halfmetre_ops", "dome"]' data-type="close" data-generator="opsDomeTime">Dome Close</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12 g-2">
            <div class="list-group rounded-0">
                <span class="list-group-item" data-cam-index='["halfmetre_cam","state"]' data-power-index='["halfmetre_power", "camera"]'  data-generator="qhyState">Camera</span>
                <span class="list-group-item" data-index='["halfmetre_cam"]' data-generator="qhyExposure">Exposure</span>
                <!-- span class="list-group-item" data-index='["halfmetre_cam"]' data-generator="qhyCooling">Cooling</span>
                <span class="list-group-item" data-index='["halfmetre_cam"]' data-generator="qhyTemperature">Temp.&nbsp;/&nbsp;RH.</span -->
                <span class="list-group-item" data-index='["halfmetre_cam"]' data-generator="h400Cooling">Cooling</span>
                <span class="list-group-item" data-index='["halfmetre_cam"]' data-generator="h400Temperature">Temp.&nbsp;/&nbsp;RH.</span>
                <span class="list-group-item" data-index='["halfmetre_cam"]' data-generator="qhyFilter">Filter</span>
                <span class="list-group-item" data-index='["halfmetre_diskspace", "data_fs_available_bytes"]' data-generator="diskSpaceGB" data-units=" GB">Disk Space</span>
                <!-- span class="list-group-item" data-focuser-index='["halfmetre_focus"]' data-power-index='["halfmetre_power", "focuser"]' data-focuser="1" data-generator="focusState">Focus</span -->
                <span class="list-group-item" data-focuser-index='["halfmetre_focus"]' data-power-index='["halfmetre_power", "focuser"]' data-generator="h400FocusState">Focus</span>
            </div>
        </div>
    </div>
    <div id="preview-container" class="row dashboard-stats">
        <div id="container" class="col-lg-8 col-md-12 g-2">
            <div class="list-group list-group-item h-100 p-0 rounded-0" style="max-height: 502px">
                <img id="preview-image" src="/data/halfmetre/thumb" data-url="/data/halfmetre/thumb" data-notify="previewImage" data-cam="halfmetre" width="100%" height="100%" class="bg-black object-fit-contain">
            </div>
        </div>
        <div class="col-lg-4 col-md-12 g-2">
            <div class="row">
                <div class="col mb-2">
                    <div id="preview-info" class="list-group rounded-0">
                        <span class="list-group-item fw-bold text-center" data-notify="previewHeader" data-cam="halfmetre">Preview</span>
                        <span class="list-group-item" data-index='["previews"]' data-generator="previewTimestamp" data-cam="halfmetre">Exposure started</span>
                        <span class="list-group-item" data-index='["previews"]' data-generator="previewExposure" data-cam="halfmetre">Exposure length</span>
                        <span class="list-group-item" data-index='["previews"]' data-generator="previewType" data-cam="halfmetre">Type</span>
                        <span class="list-group-item" data-index='["previews"]' data-generator="previewOverheads" data-cam="halfmetre">Overheads</span>
                        <span class="list-group-item" data-index='["previews"]' data-generator="previewFilename" data-cam="halfmetre">Saved as</span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="list-group rounded-0 mb-2">
                        <div class="list-group-item overflow-y-scroll pt-0" style="height: 295px">
                            <table id="log-table" class="w-100"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex flex-row-reverse mb-2">
        <span class="m-0 dashboard-stats" id="data-updated">Loading...</span>
    </div>

    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='rockit-dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='fetch-logs.js') }}"></script>
    <script>

        function h400Temperature(row, cell, data) {
          const state = getData(data, ["state"]);
          const temperature = getData(data, ["chip_temp"]);

          let label = 'ERROR';
          let style = 'text-danger';
          if (state === 0) {
            label = 'N/A';
            style = '';
          } else if (temperature !== undefined) {
            label = temperature.toFixed(1) + '&nbsp;&deg;C';
            style = '';
          }

          cell.html(label);
          cell.addClass(style);
        }

        function h400Cooling(row, cell, data) {
          const state = getData(data, ["state"]);
          const cooler_power = getData(data, ["cooler_power"]);
          const cooler_locked = getData(data, ["temperature_locked"]);

          const cooler_labels = [
            ['WARM', 'text-danger'],
            ['LOCKED', 'text-success'],
          ];

          let label = 'ERROR';
          let style = 'text-danger';
          if (state === 0) {
            label = 'N/A';
            style = '';
          } else if (cooler_power !== undefined) {
            if (cooler_locked) {
              label = '<span class="text-success">LOCKED</span>'
            } else {
              label = '';
            }
            label += '<span class="d-none d-xl-inline">&nbsp;(' + (cooler_power * 100).toFixed(0) + '%)</span>';
            style = '';
          }

          cell.html(label);
          cell.addClass(style);
        }

        function h400FocusState(row, cell, data) {
          const focuser_data = getData(data, row.data('focuser-index'));
          const powered = getData(data, row.data('power-index'));
          const status = getData(focuser_data, ['status']);
          const current_steps = getData(focuser_data, ['current_steps']);

          let label, style;
          if (powered === 0) {
            label = 'POWER OFF';
            style = 'text-danger';
          } else if (status === 0) {
            label = 'OFFLINE';
            style = 'text-danger';
          } else if (status === 1) {
            label = 'INITIALIZING';
            style = 'text-warning';
          } else if (status === 2 && current_steps !== undefined) {
            label = current_steps + ' steps';
            style = '';
          } else if (status === 3) {
            label = 'MOVING';
            style = 'text-warning';
          } else {
            label = 'ERROR';
            style = 'text-danger';
          }

          cell.html(label);
          cell.addClass(style);
        }

        $(document).ready(function () {
            const initial_camera = $(location).attr('hash').substr(1);
            if ($("#thumb-" + initial_camera).length > 0)
                selectPreview(initial_camera);

            pollDashboard('{{ url_for('halfmetre_dashboard_data') }}');
            pollLog('{{ url_for('halfmetre_log') }}');
        });
    </script>
{% endblock %}
